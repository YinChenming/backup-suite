# 软件测试报告（BackupSuite）

## 1. 引言

为提升 BackupSuite 质量并支撑验收，制定本测试报告，明确测试范围、方法与结果。覆盖核心库、CLI、GUI（Qt）、备份格式支持（tar/zip/7z）以及健壮性与性能验证。

## 2. 单元测试

- 覆盖范围：`tests/src/core` 下的 gtest 用例，包含设备抽象、压缩/加密实现、备份控制器流程，以及 7z 设备端到端往返。
- 当前状态：全部单元用例已实现并通过（7z 相关用例在缺少 7z/7za CLI 时自动跳过）。

### 2.1 用例明细

- `test_core_device.cpp`（设备读写/元数据/符号链接/写入校验）
    - `TestFolder`：枚举根目录与子目录，验证目录类型与子项数。
    - `TestFiles`：读取普通/隐藏/只读文件内容与元数据（大小、权限、隐藏属性）。
    - `TestSymbolicLink`：如存在符号链接，验证类型与元数据。
    - `TestWriteFolder`：拷贝目录到新路径，校验时间戳、权限一致。
    - `TestWriteFile`：拷贝普通、只读、隐藏文件到新路径，校验内容和元数据一致。
- `test_core_compress_device.cpp`（Tar/Zip 设备往返、加密、控制器驱动）
    - `TestTarDevice`：物理设备→TarDevice 备份，TarDevice 读取校验文件/目录存在与内容。
    - `TestZipDevice`：物理设备→ZipDevice 备份，ZipDevice 读取校验文件/目录存在与内容。
    - `TestZipEncDevice`：ZipCrypto/RC4 加密写入与读取，验证内容一致。
    - `TestBackupFromPhysicalToTar`：物理→tar 备份后读取校验。
    - `TestBackupFromPhysicalToZip`：物理→zip 备份后读取校验。
    - `TestInvalidDevice`：无效 tar/zip 路径下 is_open、get_file/get_folder/exists 均返回失败。
    - `TestEmptyPath`：空路径读取返回空，exists 为 false。
    - `TestBackupControllerPhysicalToTar/Zip`：备份控制器驱动物理→tar/zip，并验证存在性。
    - `TestBackupControllerTarToPhysical/ZipToPhysical`：tar/zip → 物理恢复，校验文件存在。
- `test_core_compress.cpp`（压缩工具互通、创建/读取、SQLite 打开）
    - `TestOpenDatabase`：内存 sqlite3 打开成功。
    - `TestOpenTar`：读取指定 tar，枚举条目并打印元数据。
    - `TestOpenZip`：读取指定 zip，枚举条目并打印元数据。
    - `TestTarCreate`：自定义 TarFile 创建文件，存在性校验后清理。
    - `TestZipCreate`：自定义 ZipFile 创建文件，存在性校验后清理。
    - `TestZipRead`：创建 zip 后重新读取，校验元数据与内容一致。
    - `TestCrossCompatibility`（TestSystemDevice）：自定义 tar 与 libarchive 互读；libarchive 创建 tar 自定义读取；内容一致校验。
- `test_core_encrypt.cpp`（ZipCrypto/RC4 加解密往返）
    - `ZipCrypto`：同一密钥下加解密往返内容一致。
    - `RC4`：同一密钥下加解密往返内容一致。
- `test_core_seven_zip_all.cpp`（SevenZip 设备构造、读写、加密、端到端恢复）
    - `ConstructAndDefaults`：SevenZipDevice 写模式构造，设置压缩/加密/密码，验证状态。
    - `WriteReadRoundtripInMemoryBackend`：内存桩文件写入 7z 后读取，内容一致。
    - `Test7zDevice`：物理→7z 备份后读取校验（缺 7z/7za 时跳过）。
    - `Test7zEncDevice`：7z AES256 加密写入，正确密码读取成功，错误密码标记但可打开（缺 7z/7za 时跳过）。
    - `TestBackupFromPhysicalTo7z`：物理→7z 备份后读取校验（缺 7z/7za 时跳过）。
    - `BackupAndRestoreWithTestData`：使用 `test_data/source` 备份到 7z，再恢复到空目录，递归比对目录/文件内容一致（缺 7z/7za 时跳过）。
- `test_core_backup_suite.cpp`（备份控制器基础流程）
    - `TestBackUp`：SystemDevice → SystemDevice 基础备份流程，打印备份目录结构。

## 3. 功能测试

目标：验证需求用例（备份/恢复 tar、zip、7z；CLI/GUI 交互；过滤/加密选项；错误处理）。采用黑盒+组合路径测试，实测数据与期望结果对比。

### 3.1 CLI 模块

测试用例（覆盖备份/恢复、tar/zip/7z、压缩/加密/过滤/异常）：

| 程序版本号 | 模块名       | 用例编号              | 用例级别 | 用例名称                  | 测试时间       | 预置条件                                   | 测试输入                                                | 操作步骤                                | 预期结果                      | 实际输出 | 测试人员 |
|-------|-----------|-------------------|------|-----------------------|------------|----------------------------------------|-----------------------------------------------------|-------------------------------------|---------------------------|------|------|
| 1.0.0 | CLI 备份    | TC-CLI-7Z-01      | 重要   | 7z 备份（含子目录与小文件）       | 2025-12-31 | third_party/7-Zip 已放置 7z.dll/7-zip.dll | `-7z test_data/source backup.7z`                    | 运行；观察返回码；校验归档存在；解压检查文件完整性           | 退出码 0，生成 backup.7z，内容与源一致 | 通过   | YCM  |
| 1.0.0 | CLI 恢复    | TC-CLI-7Z-02      | 重要   | 7z 恢复到空目录             | 2025-12-31 | 已有 backup.7z；目标目录为空                    | `-r -7z backup.7z restore_dir`                      | 运行；检查返回码；比对源与恢复目录结构/内容              | 退出码 0，目录结构与内容一致           | 通过   | YCM  |
| 1.0.0 | CLI 备份+加密 | TC-CLI-7Z-AES-03  | 重要   | 7z AES256 加密备份        | 2025-12-31 | 7z 依赖；提供密码                             | `-7z -e -p pass test_data/source enc.7z`            | 运行；验证生成；用正确密码解压成功，错误密码解压失败          | 正确密码成功，错误密码失败（提示密码错误）     | 通过   | YCM  |
| 1.0.0 | CLI 备份    | TC-CLI-ZIP-04     | 重要   | zip 备份（默认/无加密）        | 2025-12-31 | libarchive 就绪                          | `-zip test_data/source backup.zip`                  | 运行；检查归档存在；用 ZipDevice/工具读取校验        | 退出码 0，内容一致                | 通过   | YCM  |
| 1.0.0 | CLI 备份+加密 | TC-CLI-ZIP-ENC-05 | 重要   | zip 备份（ZipCrypto/RC4） | 2025-12-31 | libarchive/ZipCrypto/RC4 实现            | `-zip -p pass --enc zipcrypto src backup.zip`       | 运行；正确密码解压成功；错误密码解压失败                | 加密成功，密码正确可读，错误密码失败        | 通过   | YCM  |
| 1.0.0 | CLI 恢复    | TC-CLI-ZIP-06     | 重要   | zip 恢复到空目录            | 2025-12-31 | 备份文件存在                                 | `-r -zip backup.zip restore_zip`                    | 运行；检查返回码；比对源与恢复目录                   | 退出码 0，目录结构与内容一致           | 通过   | YCM  |
| 1.0.0 | CLI 备份    | TC-CLI-TAR-07     | 重要   | tar 备份（POSIX PAX/GNU） | 2025-12-31 | libarchive 就绪                          | `-t test_data/source backup.tar`                    | 运行；检查归档；用 TarDevice/自定义 reader 列举条目 | 退出码 0，TarDevice 可读        | 通过   | YCM  |
| 1.0.0 | CLI 恢复    | TC-CLI-TAR-08     | 重要   | tar 恢复到空目录            | 2025-12-31 | 备份文件存在                                 | `-r -t backup.tar restore_tar`                      | 运行；检查返回码；比对源与恢复目录                   | 退出码 0，目录结构与内容一致           | 通过   | YCM  |
| 1.0.0 | CLI 过滤+备份 | TC-CLI-FILTER-09  | 次要   | 按扩展名/时间过滤备份           | 2025-12-31 | test_data 含混合扩展名、时间分布                  | `-7z --include "*.txt" --after 2025-12-01 src a.7z` | 运行；解包检查仅包含过滤条件匹配的条目                 | 仅包含匹配条目                   | 通过   | YCM  |
| 1.0.0 | CLI 过滤+恢复 | TC-CLI-RESTORE-10 | 次要   | 恢复后校验过滤结果             | 2025-12-31 | 有过滤生成的 a.7z                            | `-r -7z a.7z restore_filter`                        | 运行；比对 restore_filter 仅含过滤后的文件       | 与备份时过滤结果一致                | 通过   | YCM  |
| 1.0.0 | CLI 异常    | TC-CLI-ERR-11     | 重要   | 缺少 7z 依赖的错误处理         | 2025-12-31 | 临时移除 7z 可执行/动态库                        | `-7z test_data/source backup.7z`                    | 运行；观察错误提示与退出码                       | 退出码非 0，提示缺依赖，不生成残留文件      | 通过   | YCM  |
| 1.0.0 | CLI 异常    | TC-CLI-ERR-12     | 重要   | 非法参数（空路径/不可写目录）       | 2025-12-31 | 目标不可写或空路径                              | `-7z "" backup.7z` 或 `-7z src /root/backup.7z`      | 运行；观察错误提示与退出码                       | 退出码非 0，提示非法参数/权限不足        | 通过   | YCM  |

### 3.2 GUI 模块（Qt）

- 当前状态：尚未完成 GUI 设计。

### 3.3 核心库模块（Device/Controller）

- Tar/Zip/SevenZip 设备：写入后再读取校验，跨工具互通（libarchive/7z CLI），加密/解密往返（ZipCrypto/RC4）。
- BackupController：物理→归档→物理往返一致性；错误路径/空路径处理。
- SystemDevice：符号链接/隐藏/只读文件的元数据与内容验证。

## 4. 代码测试

- 静态分析：建议使用 MSVC /analyze 或 clang-tidy；关注 DLL 导出警告（C4251）、类型转换告警（C4244/C4267），对无法消除的告警记录理由。
- 代码规范：命名/注释/接口一致性抽查核心模块（backup_controller.cpp、compresses_device.cpp、tar.cpp）。

## 5. 健壮性测试

- 依赖缺失：移除 7z.dll 后运行 `-7z`，期望友好报错且不生成残留文件。
- 路径异常：不可写目标目录、长路径、非法字符，期望报错并退出码非零。
- 中断场景：备份过程中手动终止进程，确认下次运行不会因残留临时文件导致崩溃。

## 6. 性能测试（抽样）

- 小文件批量：验证扫描/打包吞吐，记录时间与 CPU 占用。
- 大文件单体：验证单文件读写与压缩性能，关注内存峰值。
- 状态：抽样通过，后续可建立基线并纳入自动化。

## 7. 测试结果分析

| 测试模块             | 测试项目/场景             | 测试结果 | 备注                      |
|------------------|---------------------|------|-------------------------|
| CLI              | 7z/tar/zip 备份/恢复/过滤 | 通过   | 需本地 7z 依赖；错误场景用例已覆盖     |
| Core Device      | Tar/Zip/7z 读写一致性、加密 | 通过   | 缺少 7z/7za 时相关用例自动跳过     |
| BackupController | 物理<->归档 往返一致性       | 通过   | 单元与集成用例均通过              |
| GUI              | 启动/路径选择/进度与错误提示     | 未测   | 待补充 Qt 环境与用例            |
| 健壮性              | 缺依赖、不可写路径、长路径       | 通过   | 7z 依赖缺失/非法参数和中断/长路径测试通过 |
| 性能（抽样）           | 小文件批量 / 大文件单体       | 抽样通过 | 基线未固化，需持续跟踪             |

结论：核心库、BackupController 与 CLI 覆盖的单元/功能用例通过；7z 相关在缺少 7z/7za 时跳过；健壮性部分场景与性能仅做抽样，GUI尚未完成。
